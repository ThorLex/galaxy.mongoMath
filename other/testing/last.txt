// mgm.js
const mongoose = require("mongoose");
const dbUtils = require("./dbUtils.js");
const dbStatsReplicaSet = require("./dbStatsReplicaSet.js");
const dbStats = require("./dbStats.js");

class MGM {
  constructor(uri) {
    this.uri = uri;
  }

  async connect() {
    try {
      await mongoose.connect(this.uri, {
        useNewUrlParser: true,
        useUnifiedTopology: true,
      });
      console.log("Connexion à la base de données réussie !");
    } catch (error) {
      console.error("Erreur de connexion à la base de données:", error);
    }
  }

  async main() {
    console.log("Bonjour");
    const data = await dbUtils.listCollectionsAndDocuments();
    console.log("Toutes les collections et leurs documents:", data);
  }

  async counting() {
    const counts = await dbUtils.countDocumentsPerCollection();
    console.log("Nombre de documents par collection:", counts);
  }

  async getInfo() {
    const info = await dbUtils.getDatabaseInfo();
    console.log("Informations sur la base de données:", info);
  }

  async calculate(period = "day") {
    const stats = await dbStats.calculateStatistics({ period });
    console.log("Statistiques des collections:", stats);
  }

  async statsss() {
    await dbStatsReplicaSet.watchDatabaseChanges();
    setInterval(() => {
      const stats = dbStatsReplicaSet.getStatistics();
      console.log("Statistiques en temps réel :", stats);
    }, 10000);
  }

  async runFieldStatistics() {
    try {
      const ageStats = await dbStats.calculateFieldStatistics("users", "age");
      console.log("Statistiques des âges:", ageStats);

      const crossStats = await dbStats.calculateCrossFieldStatistics(
        "users",
        "age",
        "height"
      );
      console.log("Tableau croisé des âges et genres:", crossStats);
    } catch (error) {
      console.error("Erreur lors de l'exécution:", error);
    }
  }

  async close() {
    try {
      await mongoose.disconnect();
      console.log("Connexion à la base de données fermée !");
    } catch (error) {
      console.error("Erreur lors de la fermeture de la connexion :", error);
    }
  }
}

module.exports = MGM;
